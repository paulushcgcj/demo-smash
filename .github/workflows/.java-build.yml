name: Java CI

on:
  workflow_call:
    inputs:
      environment:
        description: GitHub environment; usually PR number, test or prod
        default: ''
        required: false
        type: string

jobs:
  builds:
    runs-on: ubuntu-latest
    name: Build ${{ matrix.app.name }}

    strategy:
      fail-fast: false
      matrix:
        app: 
          - { name: "Spring boot reactive", path: "springreactive" }
          - { name: "Quarkus reactive", path: "quarkus" }
    defaults:
      run:
        working-directory: ${{ matrix.app.path }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ matrix.app.path }}
        restore-keys: |
          ${{ runner.os }}-maven-${{ matrix.app.path }}-
    
    - name: Build with Maven
      run: mvn -B package --file pom.xml

    - name: Update dependency graph
      uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6

  results:
    name: Job Results
    if: always()
    needs: [builds]
    runs-on: ubuntu-latest
    steps:
      - name: Job results for (${{ inputs.environment}})
        run: |
          # View results
          echo "needs.*.result: ${{ toJson(needs.*.result) }}"

      - if: contains(needs.*.result, 'failure')||contains(needs.*.result, 'canceled')
        run: |
          # Job failure found
          echo "At least one job has failed"
          exit 1